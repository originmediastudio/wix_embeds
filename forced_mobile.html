<body>
  <!-- Temporary debug DIV for container width -->
  <div id="debug-width" style="position: fixed; top: 0; left: 0; background: rgba(255,255,0,0.8); padding: 5px; font-size: 14px; z-index: 10000;">
    Container width: 
  </div>
  <script>
    function updateDebugWidth() {
      var width = window.innerWidth || document.documentElement.clientWidth;
      document.getElementById("debug-width").textContent = "Container width: " + width + "px";
    }
    updateDebugWidth();
    window.addEventListener("resize", updateDebugWidth);
  </script>
  
  <!-- ========================= DESKTOP LAYOUT ========================= -->
  <div id="desktopVersion">
    <div class="wrapper">
      <div class="centered-box">
        <div class="scale-container">
          <div class="player-frame">
            <div class="video-container">
              <video id="video" poster="https://static.originmedia.tv/website/aperture-sidebyside/jpg/puertorico-onoff.jpg">
                <source id="video-source" 
                        src="https://static.originmedia.tv/website/aperture-sidebyside/mov/puertorico-onoff.mov" 
                        type="video/mp4"/>
                Your browser does not support the video tag.
              </video>
              <div class="overlay" id="overlay"></div>
            </div>
          </div>
          <!-- Desktop Controls -->
          <div class="controls-container">
            <div id="playpause-toggle" class="control-button"></div>
            <div class="toggle-container">
              <span class="toggle-label left-label">Without Aperture</span>
              <label class="toggle-switch">
                <input type="checkbox" id="toggle" />
                <span class="slider"></span>
              </label>
              <span class="toggle-label right-label">With Aperture</span>
            </div>
            <div id="sound-toggle" class="control-button"></div>
          </div>
          <!-- Desktop Carousel -->
          <div class="video-buttons-container">
            <button id="scroll-left" class="scroll scroll-left">&#9664;</button>
            <div class="video-buttons-wrapper">
              <div class="video-buttons-inner"></div>
            </div>
            <button id="scroll-right" class="scroll scroll-right">&#9654;</button>
          </div>
          <div id="instructions">Select an example above to see how Aperture elevates ads on CTV.</div>
          <div id="instructions" style="font-style:italic; font-size:11px; margin-top:10px;">
            Videos above shown for demonstration purposes.
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ========================= MOBILE LAYOUT ========================= -->
  <div id="mobileVersion">
    <div class="mobile-player-frame">
      <div class="mobile-poster-wrapper">
        <img id="mobilePoster" class="mobile-poster-img" src="https://static.originmedia.tv/website/aperture-sidebyside/jpg/puertorico-onoff.jpg" alt="Video Poster" />
        <div class="mobile-overlay" id="mobileOverlay"></div>
        <video id="mobileVideo" preload="none" playsinline webkit-playsinline>
          <source id="mobileVideoSource" src="" type="video/mp4"/>
        </video>
      </div>
    </div>
    <div class="mobile-controls-row">
      <div class="mobile-left-wrap">
        <span class="mobile-toggle-label">Aperture Overlays:</span>
        <label class="mobile-toggle-switch">
          <input type="checkbox" id="mobileToggle" />
          <span class="mobile-slider"></span>
        </label>
      </div>
      <div id="mobilePlayBtn" class="mobile-play-btn"></div>
    </div>
    <div id="mobileDescription" class="mobile-description">
      <div id="mobileLeftArrow" class="mdNavArrow">◀️</div>
      <div id="mobileDataTitle" class="mdTitle"></div>
      <div id="mobileRightArrow" class="mdNavArrow">▶️</div>
      <div id="mobileDataBrand" class="mdBrand"></div>
      <div id="mobileDataTagHeader" class="mdTagHeader">Aperture Overlays:
        <div id="mobileDataTags" class="mdTags"></div>
      </div>
    </div>
    <div id="instructions" style="font-style:italic;">
      Videos above shown for demonstration purposes.
    </div>
  </div>
  
  <!-- ======================= SCRIPT: FETCH & PARSE TSV DATA =========================== -->
  <script>
    // Utility function for mobile detection
    function isMobile() {
      return (
        /Mobi|Android|iPhone|Windows Phone/i.test(navigator.userAgent) ||
        (navigator.maxTouchPoints > 0 && window.innerWidth <= 800)
      );
    }
  
    // Function to parse TSV text and filter rows where playerInclude is "TRUE"
    function parseTSV(tsvText) {
      const lines = tsvText.trim().split("\n");
      const headers = lines[0].split("\t").map(h => h.trim());
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const values = line.split("\t").map(v => v.trim());
        const row = {};
        headers.forEach((header, index) => {
          row[header] = values[index] || "";
        });
        if (row["playerInclude"] && row["playerInclude"].toUpperCase() === "TRUE") {
          data.push({
            dataName: row["dataName"],
            videoTitle: row["videoTitle"],
            videoBrand: row["videoBrand"],
            videoTags: row["videoTags"]
          });
        }
      }
      return data;
    }
  
    document.addEventListener("DOMContentLoaded", function() {
      // Fetch the TSV from Google Sheets
      fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vQD7U-L7I573pEiOaJ844rhaDUCn0yoUMy4dAiTxRsNHVowgaSDecjcL-UrCGCSyQdrt7eJ8hQSOBW-/pub?gid=0&single=true&output=tsv')
        .then(response => response.text())
        .then(tsvText => {
          const videoData = parseTSV(tsvText);
  
          // =================== DESKTOP LOGIC ===================
          if (!isMobile()) {
            document.getElementById("desktopVersion").style.display = "block";
            document.getElementById("mobileVersion").style.display = "none";
  
            function whiteFlash() {
              const overlay = document.getElementById("overlay");
              overlay.style.opacity = "1";
              overlay.style.transition = "none";
              setTimeout(() => {
                overlay.style.transition = "opacity 0.4s ease-out";
                overlay.style.opacity = "0";
              }, 100);
            }
  
            // Preload posters
            const preloadedPosters = {};
            videoData.forEach(data => {
              if (!preloadedPosters[data.dataName]) {
                const img = new Image();
                img.src = "https://static.originmedia.tv/website/aperture-sidebyside/jpg/" + data.dataName + "-onoff.jpg";
                preloadedPosters[data.dataName] = true;
              }
            });
  
            const innerContainer = document.querySelector(".video-buttons-inner");
            const visibleCount = 5;
            const gap = 6;
            const wrapperWidth = 912;
            const totalOriginal = videoData.length;
            let activeDataName = null;
  
            function createVideoButton(data) {
              const button = document.createElement("button");
              button.classList.add("video-button");
              button.setAttribute("data-name", data.dataName);
              button.setAttribute("data-src", "https://static.originmedia.tv/website/aperture-sidebyside/mov/" + data.dataName + "-onoff.mov");
              button.setAttribute("data-poster", "https://static.originmedia.tv/website/aperture-sidebyside/jpg/" + data.dataName + "-onoff.jpg");
  
              const titleSpan = document.createElement("span");
              titleSpan.classList.add("video-title");
              titleSpan.textContent = data.videoTitle;
              button.appendChild(titleSpan);
  
              const brandSpan = document.createElement("span");
              brandSpan.classList.add("video-brand");
              brandSpan.textContent = data.videoBrand;
              button.appendChild(brandSpan);
  
              const tagsDiv = document.createElement("div");
              tagsDiv.classList.add("video-tags");
              const headerSpan = document.createElement("span");
              headerSpan.classList.add("tag-header");
              headerSpan.textContent = "Aperture Overlays:";
              tagsDiv.appendChild(headerSpan);
  
              data.videoTags.split(",").forEach(tagText => {
                const tagSpan = document.createElement("span");
                tagSpan.classList.add("video-tag");
                tagSpan.textContent = tagText.trim();
                tagsDiv.appendChild(tagSpan);
              });
              button.appendChild(tagsDiv);
  
              return button;
            }
  
            const buttons = videoData.map(createVideoButton);
  
            if (totalOriginal <= visibleCount) {
              document.getElementById("scroll-left").style.display = "none";
              document.getElementById("scroll-right").style.display = "none";
              innerContainer.innerHTML = "";
              buttons.forEach((btn, idx) => {
                if (idx === 0) {
                  btn.classList.add("active");
                  activeDataName = btn.getAttribute("data-name");
                }
                innerContainer.appendChild(btn);
              });
              const fixedButtonWidth = (wrapperWidth - 24) / 5;
              const totalWidth = totalOriginal * fixedButtonWidth + (totalOriginal - 1) * gap;
              const marginLeft = (wrapperWidth - totalWidth) / 2;
              innerContainer.style.marginLeft = marginLeft + "px";
              innerContainer.style.transform = "translateX(0)";
            } else {
              const preClones = buttons.slice(-visibleCount).map(btn => btn.cloneNode(true));
              const postClones = buttons.slice(0, visibleCount).map(btn => btn.cloneNode(true));
              preClones.forEach(btn => innerContainer.appendChild(btn));
              buttons.forEach((btn, idx) => {
                if (idx === 0) {
                  btn.classList.add("active");
                  activeDataName = btn.getAttribute("data-name");
                }
                innerContainer.appendChild(btn);
              });
              postClones.forEach(btn => innerContainer.appendChild(btn));
  
              let currentIndex = visibleCount;
              innerContainer.style.transform =
                `translateX(-${currentIndex * ((wrapperWidth - 24) / visibleCount + gap)}px)`;
              let isScrolling = false;
  
              function updateActiveClasses() {
                const allButtons = innerContainer.querySelectorAll(".video-button");
                allButtons.forEach(btn => {
                  if (btn.getAttribute("data-name") === activeDataName) {
                    btn.classList.add("active");
                  } else {
                    btn.classList.remove("active");
                  }
                });
              }
  
              function animateToIndex(newIndex) {
                if (isScrolling) return;
                isScrolling = true;
                innerContainer.classList.add("scrolling");
                innerContainer.style.transition = "transform 0.6s ease-in-out";
                innerContainer.style.transform =
                  `translateX(-${newIndex * ((wrapperWidth - 24) / visibleCount + gap)}px)`;
  
                innerContainer.addEventListener("transitionend", function handler() {
                  innerContainer.style.transition = "none";
                  if (newIndex >= visibleCount + totalOriginal) {
                    currentIndex = newIndex - totalOriginal;
                    innerContainer.style.transform =
                      `translateX(-${currentIndex * ((wrapperWidth - 24) / visibleCount + gap)}px)`;
                  } else if (newIndex < visibleCount) {
                    currentIndex = newIndex + totalOriginal;
                    innerContainer.style.transform =
                      `translateX(-${currentIndex * ((wrapperWidth - 24) / visibleCount + gap)}px)`;
                  } else {
                    currentIndex = newIndex;
                  }
                  isScrolling = false;
                  innerContainer.classList.remove("scrolling");
                  updateActiveClasses();
                  innerContainer.removeEventListener("transitionend", handler);
                });
              }
  
              document.getElementById("scroll-right").addEventListener("click", function() {
                if (!isScrolling) animateToIndex(currentIndex + visibleCount);
              });
              document.getElementById("scroll-left").addEventListener("click", function() {
                if (!isScrolling) animateToIndex(currentIndex - visibleCount);
              });
            }
  
            const allInnerButtons = innerContainer.querySelectorAll(".video-button");
            allInnerButtons.forEach(button => {
              button.addEventListener("click", () => {
                const toggle = document.getElementById("toggle");
                const leftLabel = document.querySelector(".left-label");
                const rightLabel = document.querySelector(".right-label");
  
                if (!toggle.checked) {
                  toggle.checked = true;
                  leftLabel.style.color = "grey";
                  rightLabel.style.color = "#000";
                  toggle.dispatchEvent(new Event("change"));
                }
                whiteFlash();
  
                activeDataName = button.getAttribute("data-name");
                allInnerButtons.forEach(btn => {
                  if (btn.getAttribute("data-name") === activeDataName) {
                    btn.classList.add("active");
                  } else {
                    btn.classList.remove("active");
                  }
                });
  
                const video = document.getElementById("video");
                const videoSource = document.getElementById("video-source");
                video.pause();
                video.currentTime = 0;
                videoSource.src = button.getAttribute("data-src");
                video.poster = button.getAttribute("data-poster");
                video.load();
                document.getElementById("playpause-toggle").style.backgroundPosition = "0px 0";
              });
            });
  
            const toggle = document.getElementById("toggle");
            const video = document.getElementById("video");
            const soundToggle = document.getElementById("sound-toggle");
            const playPauseToggle = document.getElementById("playpause-toggle");
            const overlay = document.getElementById("overlay");
  
            video.muted = false;
            soundToggle.style.backgroundPosition = "0px 0";
            playPauseToggle.style.backgroundPosition = "0px 0";
            toggle.checked = true;
            video.style.left = "-960px";
            setTimeout(() => {
              toggle.dispatchEvent(new Event("change"));
            }, 10);
  
            toggle.addEventListener("change", () => {
              if (toggle.checked) {
                document.querySelector(".left-label").style.color = "grey";
                document.querySelector(".right-label").style.color = "#000";
              } else {
                document.querySelector(".left-label").style.color = "#000";
                document.querySelector(".right-label").style.color = "grey";
              }
              whiteFlash();
              overlay.style.transition = "none";
              setTimeout(() => {
                overlay.style.transition = "opacity 0.4s ease-out";
                overlay.style.opacity = "0";
              }, 100);
              video.style.left = toggle.checked ? "-960px" : "0px";
            });
  
            function togglePlayPause() {
              if (video.paused) {
                video.play();
                playPauseToggle.style.backgroundPosition = "-50px 0";
              } else {
                video.pause();
                playPauseToggle.style.backgroundPosition = "0px 0";
              }
            }
            video.addEventListener("click", togglePlayPause);
            playPauseToggle.addEventListener("click", togglePlayPause);
            soundToggle.addEventListener("click", () => {
              video.muted = !video.muted;
              soundToggle.style.backgroundPosition = video.muted ? "-50px 0" : "0px 0";
            });
            video.addEventListener("ended", () => {
              video.pause();
              video.currentTime = 0;
              video.load();
              if (!toggle.checked) {
                toggle.checked = true;
                document.querySelector(".left-label").style.color = "grey";
                document.querySelector(".right-label").style.color = "#000";
                toggle.dispatchEvent(new Event("change"));
              }
            });
          }
          // =================== MOBILE LOGIC ===================
          else {
            document.getElementById("desktopVersion").style.display = "none";
            document.getElementById("mobileVersion").style.display = "block";
  
            const mobilePoster = document.getElementById("mobilePoster");
            const mobileOverlay = document.getElementById("mobileOverlay");
            const mobileToggle = document.getElementById("mobileToggle");
  
            const mobilePlayBtn = document.getElementById("mobilePlayBtn");
            const mobileVideo = document.getElementById("mobileVideo");
            const mobileVideoSource = document.getElementById("mobileVideoSource");
  
            const mobileLeftArrow = document.getElementById("mobileLeftArrow");
            const mobileRightArrow = document.getElementById("mobileRightArrow");
  
            const mobileDataTitle = document.getElementById("mobileDataTitle");
            const mobileDataBrand = document.getElementById("mobileDataBrand");
            const mobileDataTags = document.getElementById("mobileDataTags");
  
            let currentIndex = 0;
            mobileToggle.checked = true;
  
            function mobileWhiteFlash() {
              // No operation for mobile white flash
            }
  
            function loadMobileData(index) {
              const data = videoData[index];
              mobilePoster.style.left = mobileToggle.checked ? "-100%" : "0";
              const basePoster = "https://static.originmedia.tv/website/aperture-sidebyside/jpg/" + data.dataName + "-onoff.jpg";
              mobilePoster.src = basePoster;
              const baseMov = "https://static.originmedia.tv/website/aperture-sidebyside/mov/" + data.dataName + "-on.mov";
              mobileVideoSource.src = baseMov;
              mobileVideo.load();
  
              mobileDataTitle.textContent = data.videoTitle;
              mobileDataBrand.textContent = "Brand: " + data.videoBrand;
  
              mobileDataTags.innerHTML = "";
              data.videoTags.split(",").forEach(t => {
                const span = document.createElement("span");
                span.classList.add("mobile-tag");
                span.textContent = t.trim();
                mobileDataTags.appendChild(span);
              });
            }
  
            mobileToggle.addEventListener("change", () => {
              mobileWhiteFlash();
              loadMobileData(currentIndex);
            });
  
            mobileLeftArrow.addEventListener("click", () => {
              currentIndex = (currentIndex - 1 + videoData.length) % videoData.length;
              mobileWhiteFlash();
              loadMobileData(currentIndex);
            });
            mobileRightArrow.addEventListener("click", () => {
              currentIndex = (currentIndex + 1) % videoData.length;
              mobileWhiteFlash();
              loadMobileData(currentIndex);
            });
  
            mobilePlayBtn.addEventListener("click", () => {
              mobileVideo.style.display = "block";
              mobileVideo.currentTime = 0;
              mobileVideo.play().then(() => {
                if (mobileVideo.requestFullscreen) {
                  mobileVideo.requestFullscreen();
                } else if (mobileVideo.webkitEnterFullscreen) {
                  mobileVideo.webkitEnterFullscreen();
                }
              }).catch(err => {
                console.warn(err);
              });
            });
  
            function hideMobileVideo() {
              mobileVideo.pause();
              mobileVideo.currentTime = 0;
              mobileVideo.load();
              mobileVideo.style.display = "none";
            }
            mobileVideo.addEventListener("ended", hideMobileVideo);
            mobileVideo.addEventListener("webkitendfullscreen", hideMobileVideo);
            document.addEventListener("fullscreenchange", () => {
              if (!document.fullscreenElement) hideMobileVideo();
            });
  
            loadMobileData(currentIndex);
          }
        })
        .catch(err => {
          console.error("Error loading TSV:", err);
        });
    });
  </script>
</body>
</html>
